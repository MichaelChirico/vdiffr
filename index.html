<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Visual Regression Testing and Graphical Diffing • vdiffr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Visual Regression Testing and Graphical Diffing">
<meta property="og:description" content="An extension to the testthat package that makes it easy
    to add graphical unit tests. It provides a Shiny application to
    manage the test cases.">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">vdiffr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    News
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Release notes</li>
    <li>
      <a href="https://www.tidyverse.org/articles/2019/01/vdiffr-0-3-0/">Version 0.3.0</a>
    </li>
    <li class="divider">
    <li>
      <a href="news/index.html">Change log</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/vdiffr/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div id="vdiffr" class="section level1">
<div class="page-header"><h1 class="hasAnchor">
<a href="#vdiffr" class="anchor"></a>vdiffr</h1></div>
<!-- badges: start -->

<p>vdiffr is an extension to the package testthat that makes it easy to test for visual regressions. It provides a Shiny app to manage failed tests and visually compare a graphic to its expected output.</p>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>Get the development version from github with:</p>
<pre class="{r}"><code><a href="https://remotes.r-lib.org/reference/install_github.html"># install.packages("remotes")
remotes::install_github("r-lib/vdiffr")</a></code></pre>
<p>or the last CRAN release with:</p>
<pre class="{r}"><code><a href="https://rdrr.io/r/utils/install.packages.html">install.packages("vdiffr")</a></code></pre>
</div>
<div id="how-to-use-vdiffr" class="section level2">
<h2 class="hasAnchor">
<a href="#how-to-use-vdiffr" class="anchor"></a>How to use vdiffr</h2>
<p>Getting started with vdiffr is a three step process:</p>
<p>1) Add expectations to by including <code><a href="reference/expect_doppelganger.html">expect_doppelganger()</a></code> in your test files.</p>
<p>1) Run <code><a href="reference/manage_cases.html">manage_cases()</a></code> to generate the plots which vdiffr will test against in the future. This will launch a shiny gadget which will ask you to confirm that each plot is correct.</p>
<p>1) Run <code><a href="https://devtools.r-lib.org//reference/test.html">devtools::test()</a></code> to execute the tests as normal.</p>
<p>When a figure doesn’t matched the saved version, vdiffr signals a failure when it is run interactively, or when it is run on Travis or Appveyor. Mismatches do not cause R CMD check to fail on CRAN machines. See the testing versus monitoring section below.</p>
<div id="adding-expectations" class="section level3">
<h3 class="hasAnchor">
<a href="#adding-expectations" class="anchor"></a>Adding expectations</h3>
<p>vdiffr integrates with testthat through the <code><a href="reference/expect_doppelganger.html">expect_doppelganger()</a></code> expectation. It takes as arguments:</p>
<ul>
<li><p>A title. This title is used in two ways. First, the title is standardised (it is converted to lowercase and any character that is not alphanumeric or a space is turned into a dash) and used as filename for storing the figure. Secondly, with ggplot2 figures the title is automatically added to the plot with <code>ggtitle()</code> (only if no ggtitle has been set).</p></li>
<li><p>A figure. This can be a ggplot object, a recordedplot, a function to be called, or more generally any object with a <code>print</code> method.</p></li>
<li><p>Optionally, a path where to store the figures, relative to <code>tests/figs/</code>. They are stored in a subfolder according to the current testthat context by default. Supply <code>path</code> to change the subfolder.</p></li>
</ul>
<p>For example, the following tests will create figures in <code>tests/figs/histograms/</code> called <code>base-graphics-histogram.svg</code> and <code>ggplot2-histogram.svg</code>:</p>
<pre class="{r}"><code>context("Histograms")

disp_hist_base &lt;- function() hist(mtcars$disp)
disp_hist_ggplot &lt;- ggplot(mtcars, aes(disp)) + geom_histogram()

vdiffr::expect_doppelganger("Base graphics histogram", disp_hist_base)
vdiffr::expect_doppelganger("ggplot2 histogram", disp_hist_ggplot)</code></pre>
<p>Note that in addition to automatic ggtitles, ggplot2 figures are assigned the minimalistic theme <code>theme_test()</code> (unless they already have been assigned a theme).</p>
</div>
<div id="managing-the-tests" class="section level3">
<h3 class="hasAnchor">
<a href="#managing-the-tests" class="anchor"></a>Managing the tests</h3>
<p>When you have added new test cases or detected regressions, you can manage those from the R command line with the functions <code><a href="reference/collect_cases.html">collect_cases()</a></code>, <code><a href="reference/validate_cases.html">validate_cases()</a></code>, and <code><a href="reference/validate_cases.html">delete_orphaned_cases()</a></code>. However it’s easier to run the shiny application <code><a href="reference/manage_cases.html">manage_cases()</a></code>. With this app you can:</p>
<ul>
<li><p>Check how a failed case differs from its expected output using three widgets: Toggle (click to swap the images), Slide and Diff.</p></li>
<li><p>Validate cases. You can do so groupwise (all new cases or all failed cases) or on a case by case basis. When you validate a failed case, the old expected output is replaced by the new one.</p></li>
<li><p>Delete orphaned cases. During a refactoring of your unit tests, some visual expectations may be removed or renamed. This means that some unused figures will linger in the <code>tests/figs/</code> folder. These figures appear in the Shiny application under the category “Orphaned” and can be cleaned up from there.</p></li>
</ul>
<p>Both <code><a href="reference/manage_cases.html">manage_cases()</a></code> and <code><a href="reference/collect_cases.html">collect_cases()</a></code> take <code>package</code> as first argument, the path to your package sources. This argument has exactly the same semantics as in devtools. You can use vdiffr tools the same way as you would use <code><a href="https://devtools.r-lib.org//reference/check.html">devtools::check()</a></code>, for example. The default is <code>"."</code>, meaning that the package is expected to be found in the current folder.</p>
<p>All validated cases are stored in <code>tests/figs/</code>. This folder may be handy to showcase the different graphs offered in your package. You can also keep track of how your plots change as you tweak their layout and add features by checking the history on Github.</p>
</div>
<div id="running-tests" class="section level3">
<h3 class="hasAnchor">
<a href="#running-tests" class="anchor"></a>Running tests</h3>
<p>You can run the tests the usual way, for example with <code><a href="https://devtools.r-lib.org//reference/test.html">devtools::test()</a></code>. New cases for which you just wrote an expectation will be skipped. Failed tests will show as an error.</p>
</div>
<div id="testing-versus-monitoring" class="section level3">
<h3 class="hasAnchor">
<a href="#testing-versus-monitoring" class="anchor"></a>Testing versus Monitoring</h3>
<p>When a figure doesn’t match its saved version, it is only reported as a failure under these circumstances:</p>
<ul>
<li><p>When the <code>NOT_CRAN</code> environment variable is set. In particular, devtools sets this when running the tests interactively.</p></li>
<li><p>On Travis, Appveyor, or any environment where <code><a href="https://rdrr.io/r/base/Sys.getenv.html">Sys.getenv("CI")</a></code> is set.</p></li>
</ul>
<p>Otherwise, the failure is ignored. The motivation for this is that vdiffr is a monitoring tool and shouldn’t cause R CMD check failures on the CRAN machines.</p>
<p>Checking the appearance of a figure is inherently fragile. It is a bit like testing for errors by matching exact error messages. These messages are susceptible to change at any time. Similarly, the appearance of plots depends on a lot of upstream code, such as the way margins and spacing are computed. vdiffr uses a special ggplot2 theme that should change very rarely, but there are just too many upstream factors that could cause breakages. For this reason, figure mismatches are not necessarily representative of actual failures.</p>
<p>Visual testing is not an alternative to writing unit tests for the internal data transformations performed during the creation of your figure. It is more of a monitoring tool that allows you to quickly check how the appearance of your figures changes over time, and to manually assess whether changes reflect actual problems in your packages.</p>
<p>If you need to override the default vdiffr behaviour on CRAN (not recommended) or Travis (for example to run the tests in a particular builds but not others), set the <code>VDIFFR_RUN_TESTS</code> environment variable to “true” or “false”.</p>
</div>
<div id="rstudio-integration" class="section level3">
<h3 class="hasAnchor">
<a href="#rstudio-integration" class="anchor"></a>RStudio integration</h3>
<p>An addin to launch <code><a href="reference/manage_cases.html">manage_cases()</a></code> is provided with vdiffr. Use the addin menu to launch the Shiny app in an RStudio dialog.</p>
<p><img src="https://raw.githubusercontent.com/r-lib/vdiffr/readme/rstudio-vdiffr.png" alt="RStudio addin"></p>
</div>
<div id="ess-integration" class="section level3">
<h3 class="hasAnchor">
<a href="#ess-integration" class="anchor"></a>ESS integration</h3>
<p>To use the Shiny app as part of ESS devtools integration with <code>C-c C-w C-v</code>, include something like this in your init file:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb4-1"><a href="#cb4-1"></a>(<span class="kw">defun</span><span class="fu"> ess-r-vdiffr-manage-cases </span>()</span>
<span id="cb4-2"><a href="#cb4-2"></a>  (interactive)</span>
<span id="cb4-3"><a href="#cb4-3"></a>  (ess-r-package-send-process <span class="st">"vdiffr::manage_cases(%s)</span><span class="sc">\n</span><span class="st">"</span></span>
<span id="cb4-4"><a href="#cb4-4"></a>                              <span class="st">"Manage vdiffr cases for %s"</span>))</span>
<span id="cb4-5"><a href="#cb4-5"></a></span>
<span id="cb4-6"><a href="#cb4-6"></a>(define-key ess-r-package-dev-map <span class="st">"\C-v"</span> 'ess-r-vdiffr-manage-cases)</span></code></pre></div>
</div>
</div>
<div id="debugging" class="section level2">
<h2 class="hasAnchor">
<a href="#debugging" class="anchor"></a>Debugging</h2>
<p>It is sometimes difficult to understand the cause of a failure. This usually indicates that the plot is not created deterministically. Potential culprits are:</p>
<ul>
<li><p>Some of the plot components depend on random variation. Try setting a seed.</p></li>
<li><p>The plot depends on some system library. For instance sf plots depend on libraries like GEOS and GDAL. It might not be possible to test these plots with vdiffr (which can still be used for manual inspection, add a [testthat::skip()] before the <code><a href="reference/expect_doppelganger.html">expect_doppelganger()</a></code> call in that case).</p></li>
</ul>
<p>To help you understand the causes of a failure, vdiffr automatically logs the SVG diff of all failures when run under R CMD check. The log is located in <code>tests/vdiffr.Rout.fail</code> and should be displayed on Travis.</p>
<p>You can also set the <code>VDIFFR_LOG_PATH</code> environment variable with <code><a href="https://rdrr.io/r/base/Sys.setenv.html">Sys.setenv()</a></code> to unconditionally (also interactively) log failures in the file pointed by the variable.</p>
</div>
<div id="implementation" class="section level2">
<h2 class="hasAnchor">
<a href="#implementation" class="anchor"></a>Implementation</h2>
<div id="testthat-reporter" class="section level3">
<h3 class="hasAnchor">
<a href="#testthat-reporter" class="anchor"></a>testthat Reporter</h3>
<p>vdiffr extends testthat through a custom <code>Reporter</code>. <a href="https://github.com/hadley/testthat/blob/master/R/reporter.R">Reporters</a> are classes (R6 classes in recent versions of testthat) whose instances collect cases and output a summary of the tests. While reporters are usually meant to provide output for the end user, you can also use them in functions to interact with testthat.</p>
<p>vdiffr has a <a href="https://github.com/r-lib/vdiffr/blob/master/R/testthat-reporter.R">special reporter</a> that does nothing but activate a collecter for the visual test cases. <code><a href="reference/collect_cases.html">collect_cases()</a></code> calls <code><a href="https://devtools.r-lib.org//reference/test.html">devtools::test()</a></code> with this reporter. When <code><a href="reference/expect_doppelganger.html">expect_doppelganger()</a></code> is called, it first checks whether the case is new or failed. If that’s the case, and if it finds that vdiffr’s collecter is active, it calls the collecter, which in turns records the current test case.</p>
<p>This enables the user to run the tests with the usual development tools and get feedback in the form of skipped or failed cases. On the other hand, when vdiffr’s tools are called, we collect information about the tests of interest and wrap them in a data structure.</p>
</div>
<div id="svg-comparison" class="section level3">
<h3 class="hasAnchor">
<a href="#svg-comparison" class="anchor"></a>SVG comparison</h3>
<p>Comparing SVG files is convenient and should work correctly in most situations. However, SVG is not suitable for tracking really subtle changes and regressions. See <a href="https://github.com/r-lib/vdiffr/issues/1">vdiffr’s issue #1</a> for a discussion on this. vdiffr may gain additional comparison backends in the future to make the tests more stringent.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="links">
<h2>Links</h2>
<ul class="list-unstyled">
<li>Download from CRAN at <br><a href="https://cloud.r-project.org/package=vdiffr">https://​cloud.r-project.org/​package=vdiffr</a>
</li>
<li>Browse source code at <br><a href="https://github.com/r-lib/vdiffr/">https://​github.com/​r-lib/​vdiffr/​</a>
</li>
<li>Report a bug at <br><a href="https://github.com/r-lib/vdiffr/issues">https://​github.com/​r-lib/​vdiffr/​issues</a>
</li>
</ul>
</div>
<div class="license">
<h2>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>
<div class="developers">
<h2>Developers</h2>
<ul class="list-unstyled">
<li>Lionel Henry <br><small class="roles"> Maintainer, author </small>  </li>
<li>Carl Sutherland <br><small class="roles"> Author </small>  <br><small>(jg-imagediff library)</small>
</li>
<li>David Hong <br><small class="roles"> Author </small>  <br><small>(TwoFace library)</small>
</li>
<li>T Jake Luciani <br><small class="roles"> Author </small>  <br><small>(svglite)</small>
</li>
<li>Matthieu Decorde <br><small class="roles"> Author </small>  <br><small>(svglite)</small>
</li>
<li>Vaudor Lise <br><small class="roles"> Author </small>  <br><small>(svglite)</small>
</li>
<li><a href="authors.html">All authors...</a></li>
</ul>
</div>

  <div class="dev-status">
<h2>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/r-lib/vdiffr/actions"><img src="https://github.com/r-lib/vdiffr/workflows/R-CMD-check/badge.svg" alt="R-CMD-check"></a></li>
<li><a href="https://codecov.io/gh/r-lib/vdiffr?branch=master"><img src="https://codecov.io/gh/r-lib/vdiffr/branch/master/graph/badge.svg" alt="Codecov test coverage"></a></li>
<li><a href="https://cran.r-project.org/package=vdiffr"><img src="https://www.r-pkg.org/badges/version/vdiffr" alt="CRAN status"></a></li>
</ul>
</div>
</div>
</div>


      <footer><div class="copyright">
  <p>Developed by Lionel Henry, Carl Sutherland, David Hong, T Jake Luciani, Matthieu Decorde, Vaudor Lise.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
